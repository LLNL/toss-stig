# https://www.stigviewer.com/stig/tri-lab_operating_system_stack_toss_4/2022-08-29/finding/V-252947

# Verify TOSS limits the number of concurrent sessions to less than or equal
# to 256 for all accounts and/or account types by issuing the following command:
#
#     $ sudo grep -r -s '^[^#].*maxlogins' /etc/security/limits.conf /etc/security/limits.d/*.conf
#     * hard maxlogins 256
#
# This can be set as a global domain (with the * wildcard) but may be set
# differently for multiple domains.
#
# If the "maxlogins" item is missing, commented out, or the value is set greater
# than "256" and is not documented with the Information System Security Officer
# (ISSO) as an operational requirement for all domains that have the "maxlogins"
# item assigned, this is a finding.


- name: TOSS-04-020010 - TOSS must limit the number of concurrent sessions to 256 for all accounts and/or account types.
  block:
    - name: TOSS-04-020010 - check maxlogins line
      ansible.builtin.command: 'grep "^[^#].*maxlogins" /etc/security/limits.conf /etc/security/limits.d/*.conf'
      register: maxlogins
      failed_when: false
      changed_when: false
      check_mode: false
    - name: TOSS-04-020010 - Ensure maxlogins is set to 256 or lower
      ansible.builtin.lineinfile:
        state: present
        path: /etc/security/limits.conf
        regexp: ^#?\*.*maxlogins
        line: '*          hard    maxlogins     {{ max_concurrent_login_sessions }}'
        create: true
        mode: '644'
      when:
        - maxlogins.stdout is defined
        - (maxlogins.stdout == "") or (maxlogins.stdout_lines is search('maxlogins\s+25[7-9]')) or (maxlogins.stdout_lines is search('maxlogins\s+2[6-9][0-9]')) or (maxlogins.stdout_lines is search('maxlogins\s+[3-9][0-9][0-9]')) or (maxlogins.stdout_lines is search('maxlogins\s+[1-9]+[0-9]{3,}'))
  when:
    - toss_04_020010 | bool
  tags:
    - V-252947
    - SRG-OS-000027-GPOS-00008
    - TOSS-04-020010
    - DISA-STIG-TOSS-04-020010
    - low_severity
    - CCI-000054
    - isso_documented
